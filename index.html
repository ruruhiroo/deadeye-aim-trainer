<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEAD//EYE - Aim Trainer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        :root {
            --primary: #FF4655;
            --primary-glow: rgba(255, 70, 85, 0.4);
            --bg-dark: #0F1923;
            --bg-darker: #0A1018;
            --bg-card: rgba(15, 25, 35, 0.9);
            --text-primary: #ECE8E1;
            --text-secondary: #768079;
            --accent-cyan: #00FFC2;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: #050508;
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* 3D„Ç≠„É£„É≥„Éê„Çπ */
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* ÁöÑÔºà„Éí„ÉÉ„ÉàÂà§ÂÆöÁî®„ÅÆÈÄèÊòé„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºâ */
        .target-overlay {
            position: fixed;
            pointer-events: none;
            z-index: 5;
        }


        /* „É°„Éã„É•„Éº */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(255, 70, 85, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 255, 194, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(15, 25, 35, 0.95) 0%, rgba(5, 5, 8, 1) 100%);
            overflow: hidden;
        }

        .menu-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, transparent 40%, rgba(255, 70, 85, 0.03) 50%, transparent 60%),
                linear-gradient(225deg, transparent 40%, rgba(0, 255, 194, 0.03) 50%, transparent 60%);
            animation: menuShine 8s ease-in-out infinite;
        }

        @keyframes menuShine {
            0%, 100% { opacity: 0.5; transform: translateX(-10%); }
            50% { opacity: 1; transform: translateX(10%); }
        }

        .menu-screen.hidden { display: none; }

        /* ËÉåÊôØ„Ç∞„É™„ÉÉ„Éâ */
        .menu-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(255, 70, 85, 0.05) 1px, transparent 1px),
                linear-gradient(0deg, rgba(255, 70, 85, 0.05) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(60px); }
        }

        /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .menu-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0;
            animation: particleFloat 10s ease-in-out infinite;
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 1s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 3s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 5s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 6s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 7s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 8s; }
        .particle:nth-child(10) { left: 15%; animation-delay: 0.5s; background: var(--accent-cyan); }
        .particle:nth-child(11) { left: 35%; animation-delay: 2.5s; background: var(--accent-cyan); }
        .particle:nth-child(12) { left: 55%; animation-delay: 4.5s; background: var(--accent-cyan); }
        .particle:nth-child(13) { left: 75%; animation-delay: 6.5s; background: var(--accent-cyan); }
        .particle:nth-child(14) { left: 95%; animation-delay: 8.5s; background: var(--accent-cyan); }

        @keyframes particleFloat {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }

        /* „Ç≥„Éº„Éä„Éº„Éá„Ç≥„É¨„Éº„Ç∑„Éß„É≥ */
        .corner-deco {
            position: absolute;
            width: 150px;
            height: 150px;
            border: 2px solid transparent;
            pointer-events: none;
            z-index: 0;
        }

        .corner-deco.top-left {
            top: 30px;
            left: 30px;
            border-top-color: var(--primary);
            border-left-color: var(--primary);
        }

        .corner-deco.top-right {
            top: 30px;
            right: 30px;
            border-top-color: var(--accent-cyan);
            border-right-color: var(--accent-cyan);
        }

        .corner-deco.bottom-left {
            bottom: 30px;
            left: 30px;
            border-bottom-color: var(--accent-cyan);
            border-left-color: var(--accent-cyan);
        }

        .corner-deco.bottom-right {
            bottom: 30px;
            right: 30px;
            border-bottom-color: var(--primary);
            border-right-color: var(--primary);
        }

        /* „Çπ„Ç≠„É£„É≥„É©„Ç§„É≥ */
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.3;
            animation: scanlineMove 4s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes scanlineMove {
            0% { top: -4px; }
            100% { top: 100%; }
        }

        /* Ë®≠ÂÆö„Éú„Çø„É≥ */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 70, 85, 0.3);
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 200;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: rotate(45deg);
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid rgba(255, 70, 85, 0.3);
            z-index: 300;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 70, 85, 0.2);
        }

        .settings-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--primary);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .settings-close:hover {
            color: var(--primary);
        }

        .settings-content {
            padding: 20px;
        }

        .setting-item { margin-bottom: 15px; }

        .setting-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .setting-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
        }

        .setting-slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .setting-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 70, 85, 0.1);
            border-bottom: 1px solid rgba(255, 70, 85, 0.1);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .toggle-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .toggle-label input[type="checkbox"]:checked + span {
            color: var(--accent-cyan);
        }

        .setting-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .setting-input-row .setting-slider {
            flex: 1;
        }

        .setting-number {
            width: 70px;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 70, 85, 0.3);
            color: var(--accent-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            text-align: center;
        }

        .setting-number:focus {
            outline: none;
            border-color: var(--primary);
        }

        .setting-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 70, 85, 0.2);
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .color-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .color-btn {
            width: 28px;
            height: 28px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.15);
        }

        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 12px currentColor;
        }

        /* Ë®≠ÂÆö„Éë„Éç„É´Èñã„ÅÑ„Å¶„ÇãÊôÇ„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 250;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞ */
        .ranking-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #FFD700;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 200;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ranking-btn:hover {
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .ranking-btn svg {
            width: 24px;
            height: 24px;
        }

        .offline-ranking-btn {
            top: 140px;
            border-color: rgba(255, 193, 7, 0.3);
            color: #FFC107;
        }

        .offline-ranking-btn:hover {
            border-color: #FFC107;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
        }

        .offline-ranking-btn svg {
            width: 24px;
            height: 24px;
        }

        .ranking-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 250;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .ranking-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .ranking-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 450px;
            max-height: 80vh;
            background: var(--bg-card);
            border: 1px solid rgba(255, 215, 0, 0.3);
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .ranking-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }

        .ranking-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: #FFD700;
        }

        .ranking-close, .ranking-refresh {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ranking-close:hover, .ranking-refresh:hover {
            color: var(--primary);
        }
        
        .ranking-refresh {
            font-size: 1rem;
        }
        
        .ranking-refresh:active {
            transform: rotate(180deg);
        }
        
        .ranking-refresh.loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .ranking-notice {
            padding: 10px 15px;
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid #FFC107;
            color: #FFC107;
            font-size: 0.75rem;
            margin: 10px 15px;
            border-radius: 3px;
        }

        .ranking-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-tab {
            flex: 1;
            min-width: 80px;
            padding: 8px 6px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ranking-tab:hover {
            color: var(--text-primary);
        }

        .ranking-tab.active {
            color: #FFD700;
            border-bottom: 2px solid #FFD700;
        }

        .ranking-tab-offline {
            border-left: 2px solid rgba(255, 193, 7, 0.3);
            margin-left: 5px;
            padding-left: 15px;
        }

        .ranking-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 8px;
            border-left: 3px solid transparent;
        }

        .ranking-item:nth-child(1) {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .ranking-item:nth-child(2) {
            border-left-color: #C0C0C0;
            background: rgba(192, 192, 192, 0.05);
        }

        .ranking-item:nth-child(3) {
            border-left-color: #CD7F32;
            background: rgba(205, 127, 50, 0.05);
        }

        .ranking-position {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            width: 35px;
            color: var(--text-secondary);
        }

        .ranking-item:nth-child(1) .ranking-position { color: #FFD700; }
        .ranking-item:nth-child(2) .ranking-position { color: #C0C0C0; }
        .ranking-item:nth-child(3) .ranking-position { color: #CD7F32; }

        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .ranking-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: var(--accent-cyan);
        }

        .ranking-details {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .ranking-settings {
            font-size: 0.65rem;
            color: var(--accent-cyan);
            margin-top: 2px;
            opacity: 0.8;
        }

        .ranking-date {
            font-size: 0.65rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .ranking-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            color: var(--text-primary);
            text-shadow: 0 0 40px var(--primary-glow);
            margin-bottom: 0.3rem;
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 0.3em;
            margin-bottom: 2.5rem;
            position: relative;
            z-index: 1;
        }

        /* „Éó„É™„Çª„ÉÉ„Éà„Çª„ÇØ„Ç∑„Éß„É≥ */
        .preset-section {
            max-width: 500px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .preset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .preset-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .preset-save-btn {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 5px 12px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-save-btn:hover {
            background: var(--accent-cyan);
            color: var(--bg-dark);
        }

        .preset-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-item {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 120px;
            position: relative;
        }

        .preset-item:hover {
            border-color: var(--primary);
        }

        .preset-item.active {
            border-color: var(--accent-cyan);
            background: rgba(0, 255, 194, 0.1);
        }

        .preset-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .preset-info {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .preset-item .preset-edit,
        .preset-item .preset-delete {
            position: absolute;
            top: 5px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .preset-item .preset-edit {
            right: 22px;
        }

        .preset-item .preset-delete {
            right: 5px;
        }

        .preset-item:hover .preset-edit,
        .preset-item:hover .preset-delete {
            opacity: 1;
        }

        .preset-item .preset-edit:hover {
            color: var(--accent-cyan);
        }

        .preset-item .preset-delete:hover {
            color: var(--primary);
        }

        /* „Éó„É™„Çª„ÉÉ„Éà‰øùÂ≠ò„É¢„Éº„ÉÄ„É´ */
        .preset-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .preset-modal.active {
            display: flex;
        }

        .preset-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--primary);
            padding: 25px;
            max-width: 400px;
            width: 90%;
        }

        .preset-modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .preset-modal-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .preset-modal-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .preset-settings {
            margin-bottom: 20px;
        }

        .preset-setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .preset-setting-item label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .preset-setting-item input[type="range"] {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .preset-setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-cyan);
            border-radius: 50%;
            cursor: pointer;
        }

        .preset-setting-item span {
            font-size: 0.85rem;
            color: var(--accent-cyan);
            min-width: 45px;
            text-align: right;
        }

        .preset-setting-item.checkbox-row {
            justify-content: flex-start;
            gap: 20px;
        }

        .preset-setting-item.checkbox-row label {
            min-width: auto;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .preset-setting-item.checkbox-row input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .preset-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .preset-modal-btn {
            flex: 1;
            padding: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-modal-btn.save {
            background: var(--accent-cyan);
            border: none;
            color: var(--bg-dark);
        }

        .preset-modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: var(--text-secondary);
        }

        .preset-modal-btn:hover {
            transform: scale(1.02);
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 500px;
            position: relative;
            z-index: 1;
        }

        .mode-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 70, 85, 0.2);
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            color: inherit;
            text-align: left;
        }

        .mode-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 70, 85, 0.2);
        }

        .mode-card h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 0.2rem;
        }

        .mode-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .mode-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .mode-icon svg {
            width: 100%;
            height: 100%;
        }

        .mode-card:hover .mode-icon {
            transform: scale(1.1);
        }

        .mode-card:hover .icon-flick {
            color: var(--primary);
        }

        .mode-card:hover .icon-tracking {
            color: var(--accent-cyan);
        }

        .mode-card:hover .icon-reaction {
            color: #FFD700;
        }

        .mode-card:hover .icon-grid {
            color: #FF6B9D;
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 30px;
            z-index: 50;
            padding: 10px 30px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 70, 85, 0.3);
        }

        .hud.active { display: flex; }

        .hud-item { text-align: center; }
        .hud-label { font-size: 0.6rem; color: var(--text-secondary); letter-spacing: 0.1em; }
        .hud-value { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 700; }
        .hud-value.score { color: var(--accent-cyan); }
        .hud-value.time { color: var(--primary); }

        /* „ÇØ„É≠„Çπ„Éò„Ç¢ */
        .crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .crosshair.active { display: block; }

        .crosshair-line {
            position: absolute;
            background: var(--accent-cyan);
            box-shadow: 0 0 8px var(--accent-cyan);
        }

        .crosshair-line.horizontal { width: 16px; height: 2px; top: 50%; transform: translateY(-50%); }
        .crosshair-line.horizontal.left { right: calc(50% + 4px); }
        .crosshair-line.horizontal.right { left: calc(50% + 4px); }
        .crosshair-line.vertical { width: 2px; height: 16px; left: 50%; transform: translateX(-50%); }
        .crosshair-line.vertical.top { bottom: calc(50% + 4px); }
        .crosshair-line.vertical.bottom { top: calc(50% + 4px); }
        .crosshair-dot {
            position: absolute;
            width: 4px; height: 4px;
            background: var(--accent-cyan);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* „Åù„ÅÆ‰ªñ„ÅÆUI */
        .back-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 20px;
            background: var(--bg-card);
            border: 1px solid var(--primary);
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            z-index: 500;
            display: none;
        }
        .back-btn.active { display: block; }
        .back-btn:hover { background: var(--primary); color: var(--bg-darker); }

        .result-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .result-overlay.active { display: flex; }

        .result-card {
            text-align: center;
            padding: 2rem 3.5rem;
            background: var(--bg-card);
            border: 1px solid var(--primary);
        }
        .result-title { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--primary); margin-bottom: 1.2rem; }
        .result-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 1.2rem; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); }
        .result-buttons { display: flex; gap: 12px; justify-content: center; }
        .result-btn { padding: 10px 30px; font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; }
        .result-btn.primary { background: var(--primary); color: var(--bg-darker); }
        .result-btn.secondary { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }
        .result-btn:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        
        .result-cooldown {
            text-align: center;
            margin-bottom: 15px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            opacity: 1;
            transition: opacity 0.3s;
        }
        .result-cooldown.hidden { opacity: 0; }
        .result-cooldown #cooldownTimer {
            color: var(--accent-cyan);
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .result-rank {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, rgba(255,70,85,0.2), rgba(0,255,200,0.1));
            border: 1px solid var(--primary);
            border-radius: 8px;
        }
        .result-rank .rank-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .result-rank .rank-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-cyan);
            text-shadow: 0 0 20px rgba(0, 255, 200, 0.5);
        }
        .result-rank.new-record .rank-value {
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse-gold 1s ease infinite;
        }
        @keyframes pulse-gold {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .result-name-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
        }
        .result-name-input label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .result-name-input input {
            width: 200px;
            padding: 10px 16px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--text-secondary);
            border-radius: 4px;
            text-align: center;
            transition: all 0.3s;
        }
        .result-name-input input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(0, 255, 200, 0.05);
        }
        .result-name-input input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .countdown {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 6rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary-glow);
            z-index: 150;
            display: none;
        }
        .countdown.active { display: block; }

        .click-to-start {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-cyan);
            z-index: 160;
            display: none;
            animation: pulse 1.5s ease infinite;
        }
        .click-to-start.active { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .hit-marker {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 999;
            opacity: 0;
        }
        .hit-marker.show { animation: hitMarkerAnim 0.15s ease; }
        @keyframes hitMarkerAnim {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
        .hit-marker-line { position: absolute; width: 10px; height: 2px; background: white; }
        .hit-marker-line:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hit-marker-line:nth-child(2) { transform: rotate(-45deg) translate(-5px, 5px); }
        .hit-marker-line:nth-child(3) { transform: rotate(135deg) translate(5px, -5px); }
        .hit-marker-line:nth-child(4) { transform: rotate(-135deg) translate(-5px, -5px); }

        .tracking-indicator { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); z-index: 60; display: none; text-align: center; }
        .tracking-indicator.active { display: block; }
        .tracking-bar { width: 200px; height: 5px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; margin-top: 6px; }
        .tracking-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent-cyan)); width: 0%; border-radius: 3px; }

        .esc-hint { position: fixed; top: 75px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--text-secondary); z-index: 40; display: none; }
        .esc-hint.active { display: block; }

        .instructions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; color: var(--text-secondary); z-index: 40; display: none; }
        .instructions.active { display: block; }
    </style>
</head>
<body>
    <!-- 3D„Ç≠„É£„É≥„Éê„Çπ -->
    <canvas id="gameCanvas"></canvas>

    <!-- Ë®≠ÂÆö„Éú„Çø„É≥ -->
    <button class="settings-btn" id="settingsBtn">‚öô</button>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥ -->
    <button class="ranking-btn" id="rankingBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M2 12h20"></path>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
    </button>
    
    <!-- „Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥ -->
    <button class="ranking-btn offline-ranking-btn" id="offlineRankingBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
    </button>
    
    <!-- „Éó„É™„Çª„ÉÉ„Éà‰øùÂ≠ò„É¢„Éº„ÉÄ„É´ -->
    <div class="preset-modal" id="presetModal">
        <div class="preset-modal-content">
            <div class="preset-modal-title">„Éó„É™„Çª„ÉÉ„Éà„Çí‰ΩúÊàê</div>
            <input type="text" class="preset-modal-input" id="presetNameInput" placeholder="„Éó„É™„Çª„ÉÉ„ÉàÂêç">
            
            <div class="preset-settings">
                <div class="preset-setting-item">
                    <label>ÊÑüÂ∫¶</label>
                    <input type="range" id="presetSensitivity" min="10" max="200" value="100">
                    <span id="presetSensitivityValue">1.0</span>
                </div>
                <div class="preset-setting-item">
                    <label>ÁöÑ„ÅÆ„Çµ„Ç§„Ç∫</label>
                    <input type="range" id="presetTargetSize" min="25" max="150" value="50">
                    <span id="presetTargetSizeValue">50%</span>
                </div>
                <div class="preset-setting-item">
                    <label>„Ç≤„Éº„É†ÊôÇÈñì</label>
                    <input type="range" id="presetDuration" min="10" max="120" value="30">
                    <span id="presetDurationValue">30s</span>
                </div>
                <div class="preset-setting-item" id="presetTrackingSpeedItem" style="display: none;">
                    <label>„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶</label>
                    <input type="range" id="presetTrackingSpeed" min="25" max="200" step="5" value="100">
                    <span id="presetTrackingSpeedValue">100%</span>
                </div>
                <div class="preset-setting-item checkbox-row">
                    <label><input type="checkbox" id="presetInvertX"> Â∑¶Âè≥ÂèçËª¢</label>
                    <label><input type="checkbox" id="presetInvertY"> ‰∏ä‰∏ãÂèçËª¢</label>
                </div>
            </div>
            
            <div class="preset-modal-buttons">
                <button class="preset-modal-btn cancel" id="presetCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="preset-modal-btn save" id="presetConfirmBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div class="preset-modal" id="trackingSpeedModal">
        <div class="preset-modal-content">
            <div class="preset-modal-title">„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶„ÇíË®≠ÂÆö</div>
            <div class="preset-settings">
                <div class="preset-setting-item">
                    <label>„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶</label>
                    <input type="range" id="trackingSpeedModalSlider" min="25" max="200" step="5" value="100">
                    <span id="trackingSpeedModalValue">100%</span>
                </div>
            </div>
            <div class="preset-modal-buttons">
                <button class="preset-modal-btn save" id="trackingSpeedConfirmBtn">ÈñãÂßã</button>
            </div>
        </div>
    </div>
    
    <!-- Ë®≠ÂÆö„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div class="ranking-overlay" id="rankingOverlay"></div>
    
    <!-- „É©„É≥„Ç≠„É≥„Ç∞„Éë„Éç„É´ -->
    <div class="ranking-panel" id="rankingPanel">
        <div class="ranking-header">
            <span class="ranking-title">üåç WORLD RANKING</span>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="ranking-refresh" id="rankingRefresh" title="Êõ¥Êñ∞">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.48L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
                <button class="ranking-close" id="rankingClose">‚úï</button>
            </div>
        </div>
        <div class="ranking-notice" id="rankingNotice">
            ‚ö†Ô∏è „É©„É≥„Ç≠„É≥„Ç∞„ÅØ„ÄåÁöÑ„ÅÆ„Çµ„Ç§„Ç∫50%„Éª„Ç≤„Éº„É†ÊôÇÈñì30Áßí„Äç„ÅÆ„ÅøÂèçÊò†„Åï„Çå„Åæ„Åô
        </div>
        <div class="ranking-tabs">
            <button class="ranking-tab active" data-mode="flick" data-type="world">FLICK</button>
            <button class="ranking-tab" data-mode="tracking" data-type="world">TRACK</button>
            <button class="ranking-tab" data-mode="reaction" data-type="world">REACT</button>
            <button class="ranking-tab" data-mode="gridshot" data-type="world">GRID</button>
            <button class="ranking-tab ranking-tab-offline" data-mode="flick" data-type="offline" data-offline-mode="flick">„Ç™„Éï„É©„Ç§„É≥ FLICK</button>
            <button class="ranking-tab ranking-tab-offline" data-mode="tracking" data-type="offline" data-offline-mode="tracking">„Ç™„Éï„É©„Ç§„É≥ TRACK</button>
            <button class="ranking-tab ranking-tab-offline" data-mode="reaction" data-type="offline" data-offline-mode="reaction">„Ç™„Éï„É©„Ç§„É≥ REACT</button>
            <button class="ranking-tab ranking-tab-offline" data-mode="gridshot" data-type="offline" data-offline-mode="gridshot">„Ç™„Éï„É©„Ç§„É≥ GRID</button>
        </div>
        <div class="ranking-list" id="rankingList"></div>
    </div>
    
    <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <span class="settings-title">SETTINGS</span>
            <button class="settings-close" id="settingsClose">‚úï</button>
        </div>
        
        <div class="settings-content">
            <!-- ÊÑüÂ∫¶ -->
            <div class="setting-item">
                <div class="setting-label">ÊÑüÂ∫¶</div>
                <div class="setting-input-row">
                    <input type="range" class="setting-slider" id="sensitivitySlider" min="0.1" max="2" step="0.001" value="1">
                    <input type="number" class="setting-number" id="sensitivityInput" min="0.1" max="2" step="0.001" value="1.000">
                </div>
            </div>
            
            <!-- ÁöÑ„ÅÆ„Çµ„Ç§„Ç∫ -->
            <div class="setting-item">
                <div class="setting-label">ÁöÑ„ÅÆ„Çµ„Ç§„Ç∫<span class="setting-value" id="targetSizeValue">50%</span></div>
                <input type="range" class="setting-slider" id="targetSizeSlider" min="25" max="150" step="5" value="50">
            </div>
            
            <!-- „Ç≤„Éº„É†ÊôÇÈñì -->
            <div class="setting-item">
                <div class="setting-label">„Ç≤„Éº„É†ÊôÇÈñì<span class="setting-value" id="durationValue">30s</span></div>
                <input type="range" class="setting-slider" id="durationSlider" min="15" max="60" step="5" value="30">
            </div>
            
            <!-- „Éû„Ç¶„ÇπÂèçËª¢ -->
            <div class="setting-group">
                <label class="toggle-label">
                    <input type="checkbox" id="invertXCheckbox">
                    <span>Â∑¶Âè≥ÂèçËª¢</span>
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="invertYCheckbox">
                    <span>‰∏ä‰∏ãÂèçËª¢</span>
                </label>
            </div>
            
            <!-- „ÇØ„É≠„Çπ„Éò„Ç¢Ë®≠ÂÆö -->
            <div class="setting-section">
                <div class="section-title">‚úõ CROSSHAIR</div>
                
                <div class="setting-item">
                    <div class="setting-label">Ëâ≤</div>
                    <div class="color-options">
                        <button class="color-btn active" data-color="#00FFC2" style="background:#00FFC2"></button>
                        <button class="color-btn" data-color="#FF4655" style="background:#FF4655"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background:#FFFFFF"></button>
                        <button class="color-btn" data-color="#FFFF00" style="background:#FFFF00"></button>
                        <button class="color-btn" data-color="#00FFFF" style="background:#00FFFF"></button>
                        <button class="color-btn" data-color="#FF00FF" style="background:#FF00FF"></button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">„Çµ„Ç§„Ç∫<span class="setting-value" id="crosshairSizeValue">16</span></div>
                    <input type="range" class="setting-slider" id="crosshairSizeSlider" min="8" max="32" step="2" value="16">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">Â§™„Åï<span class="setting-value" id="crosshairThicknessValue">2</span></div>
                    <input type="range" class="setting-slider" id="crosshairThicknessSlider" min="1" max="6" step="1" value="2">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">ÈñìÈöî<span class="setting-value" id="crosshairGapValue">4</span></div>
                    <input type="range" class="setting-slider" id="crosshairGapSlider" min="0" max="12" step="1" value="4">
                </div>
                
                <div class="setting-item">
                    <label class="toggle-label">
                        <input type="checkbox" id="crosshairDotCheckbox" checked>
                        <span>‰∏≠ÂøÉ„Éâ„ÉÉ„Éà</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- „É°„Éã„É•„Éº -->
    <div class="menu-screen" id="menuScreen">
        <!-- ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà -->
        <div class="menu-grid"></div>
        <div class="menu-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="corner-deco top-left"></div>
        <div class="corner-deco top-right"></div>
        <div class="corner-deco bottom-left"></div>
        <div class="corner-deco bottom-right"></div>
        <div class="scanline"></div>
        
        <h1 class="logo">DEAD<span style="color: var(--primary)">//</span>EYE</h1>
        <p class="subtitle">Â∞ÑÊíÉË®ìÁ∑¥Â†¥</p>
        
        <!-- „Éó„É™„Çª„ÉÉ„ÉàÈÅ∏Êäû -->
        <div class="preset-section">
            <div class="preset-header">
                <span class="preset-label">„Éó„É™„Çª„ÉÉ„Éà</span>
                <button class="preset-save-btn" id="presetSaveBtn">+ ‰øùÂ≠ò</button>
            </div>
            <div class="preset-list" id="presetList">
                <button class="preset-item active" data-preset="default">
                    <span class="preset-name">„Éá„Éï„Ç©„É´„Éà</span>
                    <span class="preset-info">50% / 30s / ÊÑüÂ∫¶1.0</span>
                </button>
            </div>
        </div>
        
        <div class="mode-grid">
            <button class="mode-card" data-mode="flick">
                <div class="mode-icon icon-flick">
                    <svg viewBox="0 0 40 40" fill="none">
                        <circle cx="20" cy="20" r="16" stroke="currentColor" stroke-width="2"/>
                        <circle cx="20" cy="20" r="8" stroke="currentColor" stroke-width="2"/>
                        <circle cx="20" cy="20" r="2" fill="currentColor"/>
                        <line x1="20" y1="0" x2="20" y2="8" stroke="currentColor" stroke-width="2"/>
                        <line x1="20" y1="32" x2="20" y2="40" stroke="currentColor" stroke-width="2"/>
                        <line x1="0" y1="20" x2="8" y2="20" stroke="currentColor" stroke-width="2"/>
                        <line x1="32" y1="20" x2="40" y2="20" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <h3>FLICK SHOT</h3>
                <p>ÁöÑ„ÇíÁ¥†Êó©„ÅèÊíÉ„Å¶</p>
            </button>
            <button class="mode-card" data-mode="tracking">
                <div class="mode-icon icon-tracking">
                    <svg viewBox="0 0 40 40" fill="none">
                        <circle cx="28" cy="20" r="6" stroke="currentColor" stroke-width="2"/>
                        <path d="M4 20 Q12 10, 20 20 T36 20" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="4 2"/>
                        <polygon points="8,16 8,24 2,20" fill="currentColor"/>
                    </svg>
                </div>
                <h3>TRACKING</h3>
                <p>Âãï„ÅèÁöÑ„ÇíËøΩ„Åà</p>
            </button>
            <button class="mode-card" data-mode="reaction">
                <div class="mode-icon icon-reaction">
                    <svg viewBox="0 0 40 40" fill="none">
                        <polygon points="22,2 14,18 20,18 16,38 30,16 22,16" fill="currentColor"/>
                    </svg>
                </div>
                <h3>REACTION</h3>
                <p>Âç≥Â∫ß„Å´ÊíÉ„Å¶</p>
            </button>
            <button class="mode-card" data-mode="gridshot">
                <div class="mode-icon icon-grid">
                    <svg viewBox="0 0 40 40" fill="none">
                        <rect x="4" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="26" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="4" y="26" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <rect x="26" y="26" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                        <circle cx="20" cy="20" r="5" fill="currentColor"/>
                    </svg>
                </div>
                <h3>GRID SHOT</h3>
                <p>Ë§áÊï∞„ÇíÂá¶ÁêÜ</p>
            </button>
        </div>
    </div>

    <!-- UI -->
    <div class="hud" id="hud">
        <div class="hud-item"><div class="hud-label">SCORE</div><div class="hud-value score" id="scoreDisplay">0</div></div>
        <div class="hud-item"><div class="hud-label">TIME</div><div class="hud-value time" id="timeDisplay">30</div></div>
        <div class="hud-item"><div class="hud-label">ACCURACY</div><div class="hud-value" id="accuracyDisplay">100%</div></div>
    </div>

    <div class="tracking-indicator" id="trackingIndicator">
        <span style="color: var(--accent-cyan); font-family: 'Orbitron'; font-size: 0.8rem;">TRACKING</span>
        <div class="tracking-bar"><div class="tracking-fill" id="trackingFill"></div></div>
    </div>

    <div class="esc-hint" id="escHint">ESC „Åß„É°„Éã„É•„Éº</div>
    <button class="back-btn" id="backBtn">‚Üê MENU</button>
    <div class="instructions" id="instructions"></div>
    <div class="click-to-start" id="clickToStart">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈñãÂßã</div>
    <div class="countdown" id="countdown">3</div>

    <div class="crosshair" id="crosshair">
        <div class="crosshair-line horizontal left"></div>
        <div class="crosshair-line horizontal right"></div>
        <div class="crosshair-line vertical top"></div>
        <div class="crosshair-line vertical bottom"></div>
        <div class="crosshair-dot"></div>
    </div>

    <div class="hit-marker" id="hitMarker">
        <div class="hit-marker-line"></div>
        <div class="hit-marker-line"></div>
        <div class="hit-marker-line"></div>
        <div class="hit-marker-line"></div>
    </div>

    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <h2 class="result-title">ROUND COMPLETE</h2>
            <div class="result-rank" id="resultRank">
                <span class="rank-label">„É©„É≥„Ç≠„É≥„Ç∞</span>
                <span class="rank-value" id="rankValue">#1</span>
            </div>
            <div class="result-stats">
                <div class="stat-item"><div class="stat-value" id="finalScore">0</div><div class="stat-label">Score</div></div>
                <div class="stat-item"><div class="stat-value" id="finalAccuracy">0%</div><div class="stat-label">Accuracy</div></div>
                <div class="stat-item"><div class="stat-value" id="finalAvgTime">0</div><div class="stat-label">ÂäπÁéáÂÄ§</div></div>
            </div>
            <div class="result-name-input">
                <label for="playerNameInput">„Éó„É¨„Ç§„É§„ÉºÂêç</label>
                <input type="text" id="playerNameInput" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="12">
            </div>
            <div class="result-cooldown" id="resultCooldown">
                <span id="cooldownTimer">3</span>ÁßíÂæå„Å´Êìç‰ΩúÂèØËÉΩ
            </div>
            <div class="result-buttons">
                <button class="result-btn primary" id="retryBtn" disabled>RETRY</button>
                <button class="result-btn secondary" id="menuBtn" disabled>MENU</button>
            </div>
        </div>
    </div>

    <script>
        // „Çµ„Ç¶„É≥„Éâ
        let audioCtx = null;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playHitSound() {
            initAudio();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }
        function playMissSound() {
            initAudio();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }
        function playCountSound() {
            initAudio();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }

        // Áä∂ÊÖã
        const state = {
            currentMode: null, score: 0, hits: 0, misses: 0, totalClicks: 0,
            timeLeft: 30, isPlaying: false, gameTimer: null, targetTimer: null,
            reactionTimes: [], lastTargetTime: 0,
            sensitivity: 1.0, targetSizeMultiplier: 0.5, gameDuration: 30,
            trackingSpeed: 1.0, // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶Ôºà1.0 = 100%Ôºâ
            invertX: false, invertY: false,
            // Ë¶ñÁÇπËßíÂ∫¶
            pitch: 0, // ‰∏ä‰∏ã
            yaw: 0,   // Â∑¶Âè≥
            isPointerLocked: false, waitingForClick: false,
            pendingScore: null // „É™„Ç∂„É´„ÉàÁîªÈù¢„Åß‰øùÂ≠òÂæÖ„Å°„ÅÆ„Çπ„Ç≥„Ç¢
        };

        // Three.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        const canvas = document.getElementById('gameCanvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        
        // ÁÖßÊòé
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);
        
        const pointLight = new THREE.PointLight(0xff4655, 0.5, 100);
        pointLight.position.set(-5, 5, 5);
        scene.add(pointLight);
        
        // Â∫ä„Ç∞„É™„ÉÉ„Éâ
        const gridHelper = new THREE.GridHelper(100, 50, 0xff4655, 0x333333);
        gridHelper.position.y = -3;
        scene.add(gridHelper);
        
        // ËÉåÊôØ„ÅÆÂ£Å
        const wallGeometry = new THREE.PlaneGeometry(100, 20);
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x111122,
            emissive: 0x050510
        });
        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
        wall.position.z = -20;
        scene.add(wall);
        
        // ÁöÑ„ÇíÁÆ°ÁêÜ„Åô„ÇãÈÖçÂàó
        const targets3D = [];
        
        // DOM
        const menuScreen = document.getElementById('menuScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const accuracyDisplay = document.getElementById('accuracyDisplay');
        const countdown = document.getElementById('countdown');
        const crosshair = document.getElementById('crosshair');
        const hitMarker = document.getElementById('hitMarker');
        const resultOverlay = document.getElementById('resultOverlay');
        const trackingIndicator = document.getElementById('trackingIndicator');
        const trackingFill = document.getElementById('trackingFill');
        const instructions = document.getElementById('instructions');
        const clickToStart = document.getElementById('clickToStart');
        const hud = document.getElementById('hud');
        const escHint = document.getElementById('escHint');
        const backBtn = document.getElementById('backBtn');

        // Ë®≠ÂÆö
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityInput = document.getElementById('sensitivityInput');
        
        sensitivitySlider.addEventListener('input', (e) => {
            state.sensitivity = parseFloat(e.target.value);
            sensitivityInput.value = state.sensitivity.toFixed(3);
        });
        sensitivityInput.addEventListener('input', (e) => {
            let val = parseFloat(e.target.value);
            if (isNaN(val)) val = 1;
            val = Math.max(0.1, Math.min(2, val));
            state.sensitivity = val;
            sensitivitySlider.value = val;
        });
        sensitivityInput.addEventListener('blur', (e) => {
            e.target.value = state.sensitivity.toFixed(3);
        });
        
        document.getElementById('targetSizeSlider').addEventListener('input', (e) => {
            state.targetSizeMultiplier = parseInt(e.target.value) / 100;
            document.getElementById('targetSizeValue').textContent = e.target.value + '%';
        });
        document.getElementById('durationSlider').addEventListener('input', (e) => {
            state.gameDuration = parseInt(e.target.value);
            document.getElementById('durationValue').textContent = e.target.value + 's';
        });
        
        // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
        const trackingSpeedModal = document.getElementById('trackingSpeedModal');
        const trackingSpeedModalSlider = document.getElementById('trackingSpeedModalSlider');
        const trackingSpeedModalValue = document.getElementById('trackingSpeedModalValue');
        const trackingSpeedConfirmBtn = document.getElementById('trackingSpeedConfirmBtn');
        
        trackingSpeedModalSlider.addEventListener('input', (e) => {
            trackingSpeedModalValue.textContent = e.target.value + '%';
        });
        
        function openTrackingSpeedModal() {
            trackingSpeedModalSlider.value = state.trackingSpeed * 100;
            trackingSpeedModalValue.textContent = Math.round(state.trackingSpeed * 100) + '%';
            trackingSpeedModal.classList.add('active');
        }
        
        function closeTrackingSpeedModal() {
            trackingSpeedModal.classList.remove('active');
        }
        
        trackingSpeedConfirmBtn.addEventListener('click', () => {
            state.trackingSpeed = parseInt(trackingSpeedModalSlider.value) / 100;
            closeTrackingSpeedModal();
            // „Ç≤„Éº„É†„ÇíÈñãÂßã
            menuScreen.classList.add('hidden');
            hud.classList.add('active');
            escHint.classList.add('active');
            backBtn.classList.add('active');
            instructions.classList.add('active');
            crosshair.classList.add('active');
            instructions.textContent = modeConfig[state.currentMode].instruction;
            state.waitingForClick = true;
            clickToStart.classList.add('active');
        });
        document.getElementById('invertXCheckbox').addEventListener('change', (e) => {
            state.invertX = e.target.checked;
        });
        document.getElementById('invertYCheckbox').addEventListener('change', (e) => {
            state.invertY = e.target.checked;
        });
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢Ë®≠ÂÆö
        const crosshairSettings = {
            color: '#00FFC2',
            size: 16,
            thickness: 2,
            gap: 4,
            dot: true
        };
        
        function updateCrosshair() {
            const lines = crosshair.querySelectorAll('.crosshair-line');
            const dot = crosshair.querySelector('.crosshair-dot');
            
            lines.forEach(line => {
                line.style.background = crosshairSettings.color;
                line.style.boxShadow = `0 0 8px ${crosshairSettings.color}`;
                
                if (line.classList.contains('horizontal')) {
                    line.style.width = crosshairSettings.size + 'px';
                    line.style.height = crosshairSettings.thickness + 'px';
                    if (line.classList.contains('left')) {
                        line.style.right = `calc(50% + ${crosshairSettings.gap}px)`;
                    } else {
                        line.style.left = `calc(50% + ${crosshairSettings.gap}px)`;
                    }
                } else {
                    line.style.width = crosshairSettings.thickness + 'px';
                    line.style.height = crosshairSettings.size + 'px';
                    if (line.classList.contains('top')) {
                        line.style.bottom = `calc(50% + ${crosshairSettings.gap}px)`;
                    } else {
                        line.style.top = `calc(50% + ${crosshairSettings.gap}px)`;
                    }
                }
            });
            
            dot.style.background = crosshairSettings.color;
            dot.style.boxShadow = `0 0 10px ${crosshairSettings.color}`;
            dot.style.display = crosshairSettings.dot ? 'block' : 'none';
        }
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢Ëâ≤
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                crosshairSettings.color = btn.dataset.color;
                updateCrosshair();
            });
        });
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢„Çµ„Ç§„Ç∫
        document.getElementById('crosshairSizeSlider').addEventListener('input', (e) => {
            crosshairSettings.size = parseInt(e.target.value);
            document.getElementById('crosshairSizeValue').textContent = e.target.value;
            updateCrosshair();
        });
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢Â§™„Åï
        document.getElementById('crosshairThicknessSlider').addEventListener('input', (e) => {
            crosshairSettings.thickness = parseInt(e.target.value);
            document.getElementById('crosshairThicknessValue').textContent = e.target.value;
            updateCrosshair();
        });
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢ÈñìÈöî
        document.getElementById('crosshairGapSlider').addEventListener('input', (e) => {
            crosshairSettings.gap = parseInt(e.target.value);
            document.getElementById('crosshairGapValue').textContent = e.target.value;
            updateCrosshair();
        });
        
        // „ÇØ„É≠„Çπ„Éò„Ç¢„Éâ„ÉÉ„Éà
        document.getElementById('crosshairDotCheckbox').addEventListener('change', (e) => {
            crosshairSettings.dot = e.target.checked;
            updateCrosshair();
        });

        const modeConfig = {
            flick: { baseSize: 80, instruction: 'Ë¶ñÁÇπ„ÇíÂãï„Åã„Åó„Å¶ÁöÑ„ÇíÊíÉ„Å¶ÔºÅ' },
            tracking: { baseSize: 100, instruction: 'Âãï„ÅèÁöÑ„ÇíËøΩ„ÅÑÁ∂ö„Åë„ÇçÔºÅ' },
            reaction: { baseSize: 90, instruction: 'Âá∫Áèæ„Åó„Åü„ÇâÂç≥ÊíÉ„Å¶ÔºÅ' },
            gridshot: { baseSize: 70, instruction: 'ÂÖ®„Å¶„ÅÆÁöÑ„ÇíÂá¶ÁêÜÔºÅ' }
        };

        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', () => startGame(card.dataset.mode));
        });
        backBtn.addEventListener('click', backToMenu);
        document.getElementById('retryBtn').addEventListener('click', retryGame);
        document.getElementById('menuBtn').addEventListener('click', backToMenu);

        // Ë®≠ÂÆö„Éë„Éç„É´ÈñãÈñâ
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const settingsClose = document.getElementById('settingsClose');

        function openSettings() {
            settingsPanel.classList.add('open');
            settingsOverlay.classList.add('open');
        }

        function closeSettings() {
            settingsPanel.classList.remove('open');
            settingsOverlay.classList.remove('open');
        }

        settingsBtn.addEventListener('click', openSettings);
        settingsClose.addEventListener('click', closeSettings);
        settingsOverlay.addEventListener('click', closeSettings);

        // „É©„É≥„Ç≠„É≥„Ç∞
        const rankingBtn = document.getElementById('rankingBtn');
        const rankingPanel = document.getElementById('rankingPanel');
        const rankingOverlay = document.getElementById('rankingOverlay');
        const rankingClose = document.getElementById('rankingClose');
        const rankingRefresh = document.getElementById('rankingRefresh');
        const rankingList = document.getElementById('rankingList');
        let currentRankingMode = 'flick';
        let currentRankingType = 'world'; // 'world' or 'personal'
        
        // „É©„É≥„Ç≠„É≥„Ç∞„Ç≠„É£„ÉÉ„Ç∑„É•Ôºà5ÁßíÈñìÊúâÂäπÔºâ
        const rankingCache = {};
        const CACHE_DURATION = 5000; // 5Áßí

        function openRanking() {
            rankingPanel.classList.add('open');
            rankingOverlay.classList.add('open');
            displayRanking(currentRankingMode, currentRankingType);
        }

        function closeRanking() {
            rankingPanel.classList.remove('open');
            rankingOverlay.classList.remove('open');
        }

        rankingBtn.addEventListener('click', openRanking);
        rankingClose.addEventListener('click', closeRanking);
        rankingRefresh.addEventListener('click', () => {
            displayRanking(currentRankingMode, currentRankingType);
        });
        rankingOverlay.addEventListener('click', closeRanking);

        // „Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥
        const offlineRankingBtn = document.getElementById('offlineRankingBtn');
        offlineRankingBtn.addEventListener('click', () => {
            rankingPanel.classList.add('open');
            rankingOverlay.classList.add('open');
            // ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åó„Å¶„ÄÅÁèæÂú®„ÅÆ„É¢„Éº„Éâ„ÅÆ„Ç™„Éï„É©„Ç§„É≥„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            document.querySelectorAll('.ranking-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.type === 'offline' && (t.dataset.offlineMode || t.dataset.mode) === currentRankingMode) {
                    t.classList.add('active');
                }
            });
            currentRankingType = 'offline';
            displayRanking(currentRankingMode, currentRankingType);
        });

        // Ëá™Â∑±„É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞

        // „É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ
        document.querySelectorAll('.ranking-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabType = tab.dataset.type || 'world';
                
                if (tabType === 'offline') {
                    // „Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„Çø„ÉñÔºöÊåáÂÆö„Åï„Çå„Åü„É¢„Éº„Éâ„Åß„Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„ÇíË°®Á§∫
                    document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const offlineMode = tab.dataset.offlineMode || tab.dataset.mode;
                    currentRankingMode = offlineMode;
                    currentRankingType = 'offline';
                    displayRanking(currentRankingMode, currentRankingType);
                } else {
                    // ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞„Çø„ÉñÔºö„É¢„Éº„Éâ„ÇíÂ§âÊõ¥
                    document.querySelectorAll('.ranking-tab').forEach(t => {
                        if (t.dataset.type === 'world') {
                            t.classList.remove('active');
                        }
                    });
                    tab.classList.add('active');
                    currentRankingMode = tab.dataset.mode;
                    currentRankingType = 'world';
                    displayRanking(currentRankingMode, currentRankingType);
                }
            });
        });
        

        // „Éó„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
        const presetList = document.getElementById('presetList');
        const presetSaveBtn = document.getElementById('presetSaveBtn');
        const presetModal = document.getElementById('presetModal');
        const presetNameInput = document.getElementById('presetNameInput');
        const presetCancelBtn = document.getElementById('presetCancelBtn');
        const presetConfirmBtn = document.getElementById('presetConfirmBtn');
        
        // „Éó„É™„Çª„ÉÉ„Éà„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆË®≠ÂÆöË¶ÅÁ¥†
        const presetSensitivitySlider = document.getElementById('presetSensitivity');
        const presetSensitivityValue = document.getElementById('presetSensitivityValue');
        const presetTargetSizeSlider = document.getElementById('presetTargetSize');
        const presetTargetSizeValue = document.getElementById('presetTargetSizeValue');
        const presetDurationSlider = document.getElementById('presetDuration');
        const presetDurationValue = document.getElementById('presetDurationValue');
        const presetTrackingSpeedSlider = document.getElementById('presetTrackingSpeed');
        const presetTrackingSpeedValue = document.getElementById('presetTrackingSpeedValue');
        const presetInvertXCheckbox = document.getElementById('presetInvertX');
        const presetInvertYCheckbox = document.getElementById('presetInvertY');
        
        // „É¢„Éº„ÉÄ„É´ÂÜÖ„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà
        presetSensitivitySlider.addEventListener('input', () => {
            presetSensitivityValue.textContent = (presetSensitivitySlider.value / 100).toFixed(1);
        });
        presetTargetSizeSlider.addEventListener('input', () => {
            presetTargetSizeValue.textContent = presetTargetSizeSlider.value + '%';
        });
        presetDurationSlider.addEventListener('input', () => {
            presetDurationValue.textContent = presetDurationSlider.value + 's';
        });
        presetTrackingSpeedSlider.addEventListener('input', () => {
            presetTrackingSpeedValue.textContent = presetTrackingSpeedSlider.value + '%';
        });

        // „Éá„Éï„Ç©„É´„Éà„Éó„É™„Çª„ÉÉ„Éà
        const defaultPreset = {
            id: 'default',
            name: '„Éá„Éï„Ç©„É´„Éà',
            sensitivity: 1.0,
            targetSize: 0.5,
            duration: 30,
            invertX: false,
            invertY: false
        };

        // „Éó„É™„Çª„ÉÉ„Éà„Çí„É≠„Éº„Éâ
        function loadPresets() {
            const saved = localStorage.getItem('aimPresets');
            return saved ? JSON.parse(saved) : [defaultPreset];
        }

        // „Éó„É™„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
        function savePresets(presets) {
            localStorage.setItem('aimPresets', JSON.stringify(presets));
        }

        // „Éó„É™„Çª„ÉÉ„Éà„É™„Çπ„Éà„ÇíË°®Á§∫
        function renderPresets() {
            const presets = loadPresets();
            const currentPresetId = localStorage.getItem('currentPreset') || 'default';
            
            presetList.innerHTML = presets.map(p => `
                <button class="preset-item ${p.id === currentPresetId ? 'active' : ''}" data-preset="${p.id}">
                    <span class="preset-name">${p.name}</span>
                    <span class="preset-info">${Math.round(p.targetSize * 100)}% / ${p.duration}s / ÊÑüÂ∫¶${p.sensitivity.toFixed(1)}</span>
                    <span class="preset-edit" data-edit="${p.id}">‚úé</span>
                    ${p.id !== 'default' ? '<span class="preset-delete" data-delete="' + p.id + '">‚úï</span>' : ''}
                </button>
            `).join('');

            // „Éó„É™„Çª„ÉÉ„ÉàÈÅ∏Êäû„Ç§„Éô„É≥„Éà
            presetList.querySelectorAll('.preset-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('preset-delete')) return;
                    if (e.target.classList.contains('preset-edit')) return;
                    selectPreset(item.dataset.preset);
                });
            });

            // Á∑®ÈõÜ„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
            presetList.querySelectorAll('.preset-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditPresetModal(btn.dataset.edit);
                });
            });

            // ÂâäÈô§„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
            presetList.querySelectorAll('.preset-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePreset(btn.dataset.delete);
                });
            });
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû
        function selectPreset(presetId) {
            const presets = loadPresets();
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            // Ë®≠ÂÆö„ÇíÈÅ©Áî®
            state.sensitivity = preset.sensitivity;
            state.targetSizeMultiplier = preset.targetSize;
            state.gameDuration = preset.duration;
            state.timeLeft = preset.duration;
            state.invertX = preset.invertX;
            state.invertY = preset.invertY;
            state.trackingSpeed = preset.trackingSpeed || 1.0;

            // UI„ÇíÊõ¥Êñ∞
            sensitivitySlider.value = preset.sensitivity;
            sensitivityInput.value = preset.sensitivity.toFixed(3);
            targetSizeSlider.value = preset.targetSize * 100;
            targetSizeValue.textContent = Math.round(preset.targetSize * 100) + '%';
            durationSlider.value = preset.duration;
            durationValue.textContent = preset.duration + 's';
            invertXCheckbox.checked = preset.invertX;
            invertYCheckbox.checked = preset.invertY;

            // ÁèæÂú®„ÅÆ„Éó„É™„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
            localStorage.setItem('currentPreset', presetId);

            // UI„ÇíÊõ¥Êñ∞
            renderPresets();
        }

        // „Éó„É™„Çª„ÉÉ„Éà„ÇíÂâäÈô§
        function deletePreset(presetId) {
            let presets = loadPresets();
            presets = presets.filter(p => p.id !== presetId);
            savePresets(presets);

            // ÂâäÈô§„Åó„Åü„ÅÆ„ÅåÁèæÂú®„ÅÆ„Éó„É™„Çª„ÉÉ„Éà„Å™„Çâ„ÄÅ„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô
            if (localStorage.getItem('currentPreset') === presetId) {
                selectPreset('default');
            }

            renderPresets();
        }

        // „Éó„É™„Çª„ÉÉ„Éà‰øùÂ≠ò„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        let editingPresetId = null; // Á∑®ÈõÜ‰∏≠„ÅÆ„Éó„É™„Çª„ÉÉ„ÉàID

        function openPresetModal() {
            editingPresetId = null;
            presetNameInput.value = '';
            document.querySelector('.preset-modal-title').textContent = '„Éó„É™„Çª„ÉÉ„Éà„Çí‰ΩúÊàê';
            // ÁèæÂú®„ÅÆË®≠ÂÆö„Çí„É¢„Éº„ÉÄ„É´„Å´ÂèçÊò†
            presetSensitivitySlider.value = state.sensitivity * 100;
            presetSensitivityValue.textContent = state.sensitivity.toFixed(1);
            presetTargetSizeSlider.value = state.targetSizeMultiplier * 100;
            presetTargetSizeValue.textContent = Math.round(state.targetSizeMultiplier * 100) + '%';
            presetDurationSlider.value = state.gameDuration;
            presetDurationValue.textContent = state.gameDuration + 's';
            presetInvertXCheckbox.checked = state.invertX;
            presetInvertYCheckbox.checked = state.invertY;
            
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞„É¢„Éº„Éâ„ÅÆÊôÇ„Å†„Åë„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶Ë®≠ÂÆö„ÇíË°®Á§∫
            const presetTrackingSpeedItem = document.getElementById('presetTrackingSpeedItem');
            if (state.currentMode === 'tracking') {
                presetTrackingSpeedItem.style.display = 'flex';
                presetTrackingSpeedSlider.value = state.trackingSpeed * 100;
                presetTrackingSpeedValue.textContent = Math.round(state.trackingSpeed * 100) + '%';
            } else {
                presetTrackingSpeedItem.style.display = 'none';
            }
            
            presetModal.classList.add('active');
            presetNameInput.focus();
        }

        // „Éó„É™„Çª„ÉÉ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openEditPresetModal(presetId) {
            const presets = loadPresets();
            const preset = presets.find(p => p.id === presetId);
            if (!preset) return;

            editingPresetId = presetId;
            document.querySelector('.preset-modal-title').textContent = '„Éó„É™„Çª„ÉÉ„Éà„ÇíÁ∑®ÈõÜ';
            presetNameInput.value = preset.name;
            presetSensitivitySlider.value = preset.sensitivity * 100;
            presetSensitivityValue.textContent = preset.sensitivity.toFixed(1);
            presetTargetSizeSlider.value = preset.targetSize * 100;
            presetTargetSizeValue.textContent = Math.round(preset.targetSize * 100) + '%';
            presetDurationSlider.value = preset.duration;
            presetDurationValue.textContent = preset.duration + 's';
            presetInvertXCheckbox.checked = preset.invertX || false;
            presetInvertYCheckbox.checked = preset.invertY || false;
            
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞„É¢„Éº„Éâ„ÅÆÊôÇ„Å†„Åë„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶Ë®≠ÂÆö„ÇíË°®Á§∫
            const presetTrackingSpeedItem = document.getElementById('presetTrackingSpeedItem');
            if (state.currentMode === 'tracking') {
                presetTrackingSpeedItem.style.display = 'flex';
                presetTrackingSpeedSlider.value = (preset.trackingSpeed || 1.0) * 100;
                presetTrackingSpeedValue.textContent = Math.round((preset.trackingSpeed || 1.0) * 100) + '%';
            } else {
                presetTrackingSpeedItem.style.display = 'none';
            }
            
            presetModal.classList.add('active');
            presetNameInput.focus();
        }

        // „Éó„É™„Çª„ÉÉ„Éà‰øùÂ≠ò„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closePresetModal() {
            presetModal.classList.remove('active');
            editingPresetId = null;
        }

        // Êñ∞„Åó„ÅÑ„Éó„É™„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
        function saveNewPreset() {
            const name = presetNameInput.value.trim();
            if (!name) {
                presetNameInput.style.borderColor = 'var(--primary)';
                return;
            }

            // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§„Çí‰ΩøÁî®
            const newSensitivity = presetSensitivitySlider.value / 100;
            const newTargetSize = presetTargetSizeSlider.value / 100;
            const newDuration = parseInt(presetDurationSlider.value);
            const newInvertX = presetInvertXCheckbox.checked;
            const newInvertY = presetInvertYCheckbox.checked;
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞„É¢„Éº„Éâ„ÅÆÊôÇ„Å†„Åë„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶„ÇíÂèñÂæó
            const newTrackingSpeed = state.currentMode === 'tracking' 
                ? (parseInt(presetTrackingSpeedSlider.value) / 100) 
                : 1.0;

            const presets = loadPresets();
            
            if (editingPresetId) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ: Êó¢Â≠ò„ÅÆ„Éó„É™„Çª„ÉÉ„Éà„ÇíÊõ¥Êñ∞
                const presetIndex = presets.findIndex(p => p.id === editingPresetId);
                if (presetIndex !== -1) {
                    presets[presetIndex] = {
                        ...presets[presetIndex],
                        name: name,
                        sensitivity: newSensitivity,
                        targetSize: newTargetSize,
                        duration: newDuration,
                        invertX: newInvertX,
                        invertY: newInvertY,
                        trackingSpeed: newTrackingSpeed
                    };
                    savePresets(presets);
                    selectPreset(editingPresetId);
                }
            } else {
                // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ
                const newPreset = {
                    id: 'preset_' + Date.now(),
                    name: name,
                    sensitivity: newSensitivity,
                    targetSize: newTargetSize,
                    duration: newDuration,
                    invertX: newInvertX,
                    invertY: newInvertY,
                    trackingSpeed: newTrackingSpeed
                };
                presets.push(newPreset);
                savePresets(presets);
                selectPreset(newPreset.id);
            }

            closePresetModal();
            renderPresets();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        presetSaveBtn.addEventListener('click', openPresetModal);
        presetCancelBtn.addEventListener('click', closePresetModal);
        presetConfirmBtn.addEventListener('click', saveNewPreset);
        presetNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveNewPreset();
        });

        // ÂàùÊúüÂåñÊôÇ„Å´„Éó„É™„Çª„ÉÉ„Éà„Çí„É≠„Éº„Éâ
        renderPresets();
        
        // ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éó„É™„Çª„ÉÉ„Éà„ÇíÈÅ©Áî®
        const savedPresetId = localStorage.getItem('currentPreset');
        if (savedPresetId) {
            selectPreset(savedPresetId);
        }

        // „É©„É≥„Ç≠„É≥„Ç∞‰øùÂ≠ò
        // È†Ü‰Ωç„ÇíË®àÁÆóÔºà‰øùÂ≠òÂâç„Å´Âëº„Å≥Âá∫„ÅôÔºâ
        function calculateRank(mode, efficiency, playerName) {
            // „É©„É≥„Ç≠„É≥„Ç∞Êù°‰ª∂Ôºö„Çµ„Ç§„Ç∫50%„ÄÅÁßíÊï∞30Áßí„ÅÆ„Åø
            const targetSize = Math.round(state.targetSizeMultiplier * 100);
            if (targetSize !== 50 || state.gameDuration !== 30) {
                return -1; // Êù°‰ª∂„ÇíÊ∫Ä„Åü„Åï„Å™„ÅÑÂ†¥Âêà„ÅØÊù°‰ª∂‰∏çÈÅ©Âêà
            }
            
            const rankings = JSON.parse(localStorage.getItem('deadeyeRankings') || '{}');
            const modeRankings = rankings[mode] || [];
            const name = playerName && playerName.trim() ? playerName.trim() : 'Player';
            
            // ÁèæÂú®„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„Åß‰Ωï‰Ωç„Å´„Å™„Çã„ÅãË®àÁÆóÔºàÂêå„ÅòÂêçÂâç„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅØÈô§Â§ñÔºâ
            let rank = 1;
            for (const record of modeRankings) {
                // Âêå„ÅòÂêçÂâç„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊó¢Â≠ò„Çπ„Ç≥„Ç¢„ÅØÈô§Â§ñ„Åó„Å¶Ë®àÁÆó
                if (record.name !== name && record.efficiency >= efficiency) {
                    rank++;
                }
            }
            return Math.min(rank, 51); // 51‰Ωç‰ª•‰∏ä„ÅØÂúèÂ§ñÔºà-1„ÅØÊù°‰ª∂‰∏çÈÅ©ÂêàÔºâ
        }
        
        async function saveScore(mode, score, accuracy, playerName) {
            // ÂäπÁéáÂÄ§ = „Çπ„Ç≥„Ç¢ √ó Ê≠£Á¢∫„ÅïÔºà%„ÇíÂ∞èÊï∞„Å´Â§âÊèõÔºâ
            const accNum = parseFloat(accuracy) / 100;
            const efficiency = Math.round(score * accNum);
            
            // „Ç™„Éº„Éà„Çª„Éº„ÉñÔºö„Éó„É¨„Ç§„É§„ÉºÂêç„Åå„Å™„Åë„Çå„Å∞ÂâçÂõû„ÅÆÂêçÂâç„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞'Player'
            let name = playerName && playerName.trim() ? playerName.trim() : '';
            if (!name) {
                name = localStorage.getItem('deadeyePlayerName') || 'Player';
            }
            
            // ‰øùÂ≠ò„Åó„Åü„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíË®òÊÜ∂
            localStorage.setItem('deadeyePlayerName', name);
            
            const targetSize = Math.round(state.targetSizeMultiplier * 100);
            const scoreData = {
                name: name,
                score: score,
                accuracy: accuracy,
                efficiency: efficiency,
                duration: state.gameDuration,
                targetSize: targetSize,
                date: new Date().toLocaleDateString('ja-JP')
            };
            
            // Ëá™Â∑±„É©„É≥„Ç≠„É≥„Ç∞„Å´‰øùÂ≠òÔºàÊù°‰ª∂„Å´Èñ¢‰øÇ„Å™„ÅèÂÖ®„Å¶‰øùÂ≠òÔºâ
            const personalRankings = JSON.parse(localStorage.getItem('deadeyePersonalRankings') || '{}');
            if (!personalRankings[mode]) personalRankings[mode] = [];
            
            // Âêå„Åò„Éó„É¨„Ç§„É§„Éº„ÅÆÊó¢Â≠ò„Çπ„Ç≥„Ç¢„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const existingIndex = personalRankings[mode].findIndex(r => 
                r.name === name && r.efficiency === efficiency && r.date === scoreData.date
            );
            
            if (existingIndex === -1) {
                personalRankings[mode].push(scoreData);
                // ÂäπÁéáÂÄ§„Åß„ÇΩ„Éº„Éà„Åó„Å¶‰∏ä‰Ωç50‰ª∂„ÅÆ„Åø‰øùÂ≠ò
                personalRankings[mode].sort((a, b) => b.efficiency - a.efficiency);
                personalRankings[mode] = personalRankings[mode].slice(0, 50);
                localStorage.setItem('deadeyePersonalRankings', JSON.stringify(personalRankings));
            }
            
            // ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞Êù°‰ª∂Ôºö„Çµ„Ç§„Ç∫50%„ÄÅÁßíÊï∞30Áßí„ÅÆ„Åø
            if (targetSize === 50 && state.gameDuration === 30) {
                console.log('Attempting to save to world ranking:', {
                    mode: mode,
                    name: name,
                    score: score,
                    accuracy: accuracy,
                    efficiency: efficiency
                });
                
                // ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞API„Å´ÈÄÅ‰ø°Ôºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
                const saveToWorldRanking = async (retryCount = 0) => {
                    const maxRetries = 3;
                    try {
                        const response = await fetch('/api/ranking', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                mode: mode,
                                name: name,
                                score: score,
                                accuracy: accuracy,
                                efficiency: efficiency
                            })
                        });
                        
                        console.log('World ranking API response status:', response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                            } catch (e) {
                                errorData = { error: errorText };
                            }
                            
                            // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà
                            if (retryCount < maxRetries && (response.status >= 500 || response.status === 0)) {
                                console.log(`Retrying save... (${retryCount + 1}/${maxRetries})`);
                                await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï
                                return saveToWorldRanking(retryCount + 1);
                            }
                            
                            console.error('World ranking API error:', {
                                status: response.status,
                                error: errorData
                            });
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || errorText}`);
                        }
                        
                        const result = await response.json();
                        console.log('World ranking saved successfully:', result);
                    } catch (error) {
                        // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà
                        if (retryCount < maxRetries && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                            console.log(`Retrying save... (${retryCount + 1}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï
                            return saveToWorldRanking(retryCount + 1);
                        }
                        
                        console.error('Failed to save to world ranking:', error);
                        console.error('Error details:', error.message, error.stack);
                        // „Ç®„É©„Éº„Çí„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                        // alert('‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                };
                
                saveToWorldRanking();
            } else {
                console.log('World ranking conditions not met:', {
                    targetSize: targetSize,
                    gameDuration: state.gameDuration,
                    required: '50% and 30s'
                });
            }
        }

        // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫Ôºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
        async function displayRanking(mode, type = 'world', retryCount = 0) {
            const maxRetries = 3;
            rankingRefresh.classList.toggle('loading', retryCount === 0);
            rankingList.innerHTML = '<div class="ranking-empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
            
            // „Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞„ÅÆÂ†¥ÂêàÔºà„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆÂÖ®„Çπ„Ç≥„Ç¢Ôºâ
            if (type === 'offline') {
                rankingRefresh.classList.remove('loading');
                const personalRankings = JSON.parse(localStorage.getItem('deadeyePersonalRankings') || '{}');
                const modeRankings = personalRankings[mode] || [];
                
                if (modeRankings.length === 0) {
                    rankingList.innerHTML = '<div class="ranking-empty">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                // ÂäπÁéáÂÄ§„Åß„ÇΩ„Éº„Éà
                modeRankings.sort((a, b) => b.efficiency - a.efficiency);
                
                rankingList.innerHTML = `
                    <div style="padding: 10px 15px; background: rgba(255, 193, 7, 0.1); border-bottom: 1px solid rgba(255, 193, 7, 0.2);">
                        <div style="color: #FFC107; font-size: 0.9rem; font-weight: bold;">„Ç™„Éï„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞</div>
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">ÂÖ®${modeRankings.length}‰ª∂ÔºàÊù°‰ª∂„Å´Èñ¢‰øÇ„Å™„ÅèÂÖ®„Å¶Ë°®Á§∫Ôºâ</div>
                    </div>
                ` + modeRankings.map((r, i) => `
                    <div class="ranking-item">
                        <div class="ranking-position">#${i + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${r.name || 'Player'}</div>
                            <div class="ranking-score">${r.efficiency.toLocaleString()}</div>
                            <div class="ranking-details">Score: ${r.score} √ó Acc: ${r.accuracy}</div>
                            <div class="ranking-settings">${r.duration || 30}s / ÁöÑ${r.targetSize || 100}%</div>
                        </div>
                        <div class="ranking-date">${r.date}</div>
                    </div>
                `).join('');
                return;
            }
            
            // ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞„ÅÆÂ†¥ÂêàÔºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
            try {
                // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØÔºà„É™„Éà„É©„Ç§ÊôÇ„ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰Ωø„Çè„Å™„ÅÑÔºâ
                const cacheKey = `${mode}_${type}`;
                if (retryCount === 0 && rankingCache[cacheKey]) {
                    const cached = rankingCache[cacheKey];
                    if (Date.now() - cached.timestamp < CACHE_DURATION) {
                        console.log('Using cached ranking data');
                        rankingRefresh.classList.remove('loading');
                        const modeRankings = cached.data.rankings || [];
                        
                        if (modeRankings.length === 0) {
                            rankingList.innerHTML = '<div class="ranking-empty">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                            return;
                        }
                        
                        rankingList.innerHTML = modeRankings.map((r, i) => `
                            <div class="ranking-item">
                                <div class="ranking-position">#${i + 1}</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">${r.name || 'Player'}</div>
                                    <div class="ranking-score">${r.efficiency.toLocaleString()}</div>
                                    <div class="ranking-details">Score: ${r.score} √ó Acc: ${r.accuracy}</div>
                                </div>
                                <div class="ranking-date">${r.date}</div>
                            </div>
                        `).join('');
                        return;
                    }
                }
                
                // „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„Çø„Éº„ÇíËøΩÂä†Ôºà„É™„Éà„É©„Ç§ÊôÇÔºâ
                const cacheBuster = retryCount > 0 ? `&_t=${Date.now()}` : '';
                const response = await fetch(`/api/ranking?mode=${mode}${cacheBuster}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText };
                    }
                    
                    // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà
                    if (retryCount < maxRetries && (response.status >= 500 || response.status === 0)) {
                        console.log(`Retrying... (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï
                        return displayRanking(mode, type, retryCount + 1);
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || errorText}`);
                }
                
                const data = await response.json();
                const modeRankings = data.rankings || [];
                
                // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
                rankingCache[cacheKey] = {
                    data: data,
                    timestamp: Date.now()
                };
                
                rankingRefresh.classList.remove('loading');
                
                if (modeRankings.length === 0) {
                    rankingList.innerHTML = '<div class="ranking-empty">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }
                
                rankingList.innerHTML = modeRankings.map((r, i) => `
                    <div class="ranking-item">
                        <div class="ranking-position">#${i + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${r.name || 'Player'}</div>
                            <div class="ranking-score">${r.efficiency.toLocaleString()}</div>
                            <div class="ranking-details">Score: ${r.score} √ó Acc: ${r.accuracy}</div>
                        </div>
                        <div class="ranking-date">${r.date}</div>
                    </div>
                `).join('');
            } catch (error) {
                rankingRefresh.classList.remove('loading');
                console.error('Failed to fetch world ranking:', error);
                console.error('Error details:', error.message, error.stack);
                
                // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™„Ç®„É©„Éº„ÅÆÂ†¥Âêà
                if (retryCount < maxRetries && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    console.log(`Retrying... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï
                    return displayRanking(mode, type, retryCount + 1);
                }
                
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                let errorMessage = 'Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                if (error.message) {
                    errorMessage += `<br><small style="color: #ff6b6b;">${error.message}</small>`;
                }
                if (retryCount > 0) {
                    errorMessage += `<br><small style="color: #ff6b6b;">„É™„Éà„É©„Ç§ÂõûÊï∞: ${retryCount}/${maxRetries}</small>`;
                }
                errorMessage += `<br><button onclick="displayRanking('${mode}', '${type}')" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">ÂÜçË©¶Ë°å</button>`;
                rankingList.innerHTML = `<div class="ranking-empty">${errorMessage}</div>`;
            }
        }

        // „Éù„Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØ
        document.addEventListener('pointerlockchange', () => {
            state.isPointerLocked = document.pointerLockElement === document.body;
            if (state.isPointerLocked && state.waitingForClick) {
                state.waitingForClick = false;
                clickToStart.classList.remove('active');
                startCountdown();
            }
        });

        // „Éû„Ç¶„ÇπÁßªÂãï = Ë¶ñÁÇπÂõûËª¢Ôºà„Éó„É¨„Ç§„É§„Éº„ÅØÂãï„Åã„Å™„ÅÑÔºâ
        document.addEventListener('mousemove', (e) => {
            if (!state.isPointerLocked || !state.isPlaying) return;
            
            // ÂèçËª¢Ë®≠ÂÆö„ÇíÈÅ©Áî®Ôºà„Éá„Éï„Ç©„É´„Éà„ÅåÊ≠£Â∏∏„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„ÅßÂèçËª¢Ôºâ
            const xDir = state.invertX ? -1 : 1;
            const yDir = state.invertY ? -1 : 1;
            
            state.yaw += e.movementX * state.sensitivity * 0.1 * xDir;
            state.pitch += e.movementY * state.sensitivity * 0.1 * yDir;
            
            // Âà∂Èôê„ÇíÂ§ß„Åç„ÅèÊã°ÂºµÔºàË¶ñÁÇπ„ÅåÈ£õ„Å∞„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
            state.pitch = Math.max(-90, Math.min(90, state.pitch));
            state.yaw = Math.max(-180, Math.min(180, state.yaw));
            
            updateWorld();
        });

        function updateWorld() {
            // Three.js„Ç´„É°„É©„ÅÆÂõûËª¢Ôºà„É©„Ç∏„Ç¢„É≥„Å´Â§âÊèõÔºâ
            camera.rotation.x = -state.pitch * Math.PI / 180;
            camera.rotation.y = -state.yaw * Math.PI / 180;
        }
        
        // Three.js „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÂØæÂøú
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // „ÇØ„É™„ÉÉ„ÇØ = Â∞ÑÊíÉÔºàThree.js Raycaster‰ΩøÁî®Ôºâ
        const raycaster = new THREE.Raycaster();
        
        document.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            
            if (!state.isPointerLocked && state.waitingForClick) {
                document.body.requestPointerLock();
                return;
            }
            
            if (!state.isPlaying || !state.isPointerLocked) return;
            
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞„É¢„Éº„Éâ„Åß„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñ
            if (state.currentMode === 'tracking') return;
            
            // ÁîªÈù¢‰∏≠Â§Æ„Åã„Çâ„É¨„Ç§„Ç≠„É£„Çπ„Éà
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(targets3D);
            
            let hitAny = false;
            
            if (intersects.length > 0) {
                const target = intersects[0].object;
                if (!target.userData.hit) {
                    hitAny = true;
                    state.reactionTimes.push(Date.now() - state.lastTargetTime);
                    hitTarget3D(target);
                }
            }
            
            state.totalClicks++;
            if (!hitAny) { state.misses++; playMissSound(); }
            updateAccuracy();
            
            if (hitAny) {
                if (state.currentMode === 'flick') setTimeout(spawnTarget, 100);
                if (state.currentMode === 'reaction') scheduleReactionTarget();
                if (state.currentMode === 'gridshot') {
                    const remaining = targets3D.filter(t => !t.userData.hit).length;
                    if (remaining === 0) setTimeout(spawnGridTargets, 200);
                }
            }
        });

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') backToMenu(); });

        function startGame(mode) {
            state.currentMode = mode;
            resetState();
            
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞„É¢„Éº„Éâ„ÅÆÊôÇ„ÅØÈÄüÂ∫¶Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            if (mode === 'tracking') {
                openTrackingSpeedModal();
                return;
            }
            
            menuScreen.classList.add('hidden');
            hud.classList.add('active');
            escHint.classList.add('active');
            backBtn.classList.add('active');
            instructions.classList.add('active');
            crosshair.classList.add('active');
            instructions.textContent = modeConfig[mode].instruction;
            state.waitingForClick = true;
            clickToStart.classList.add('active');
        }

        function resetState() {
            state.score = 0; state.hits = 0; state.misses = 0; state.totalClicks = 0;
            state.timeLeft = state.gameDuration; state.isPlaying = false;
            state.reactionTimes = []; state.pitch = 0; state.yaw = 0;
            clearTargets3D();
            scoreDisplay.textContent = '0';
            timeDisplay.textContent = '--'; // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠„ÅØÊôÇÈñì„ÇíÈùûË°®Á§∫
            accuracyDisplay.textContent = '100%';
            resultOverlay.classList.remove('active');
            trackingIndicator.classList.remove('active');
            updateWorld();
        }

        function startCountdown() {
            let count = 3;
            countdown.textContent = count;
            countdown.classList.add('active');
            playCountSound();
            const interval = setInterval(() => {
                count--;
                if (count > 0) { countdown.textContent = count; playCountSound(); }
                else { countdown.classList.remove('active'); clearInterval(interval); beginPlay(); }
            }, 1000);
        }

        function beginPlay() {
            state.isPlaying = true;
            state.lastTargetTime = Date.now();
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÂÆå‰∫ÜÂæå„Å´„Çø„Ç§„Éû„ÉºË°®Á§∫ÈñãÂßã
            timeDisplay.textContent = state.timeLeft;
            state.gameTimer = setInterval(() => {
                state.timeLeft--;
                timeDisplay.textContent = state.timeLeft;
                if (state.timeLeft <= 0) endGame();
            }, 1000);
            
            switch (state.currentMode) {
                case 'flick': spawnTarget(); break;
                case 'tracking': startTracking(); break;
                case 'reaction': scheduleReactionTarget(); break;
                case 'gridshot': spawnGridTargets(); break;
            }
        }

        function getTargetSize() { return modeConfig[state.currentMode].baseSize * state.targetSizeMultiplier; }

        // 3DÁ©∫ÈñìÂÜÖ„ÅÆ„É©„É≥„ÉÄ„É†‰ΩçÁΩÆ
        function getRandomPosition3D() {
            const angle = Math.random() * Math.PI * 2;
            const dist = 200 + Math.random() * 300;
            const x = Math.cos(angle) * dist;
            const y = -100 + Math.random() * 200;
            const z = -500 - Math.random() * 300;
            return { x, y, z };
        }

        function createTarget3D(isTracking = false) {
            const size = getTargetSize() / 80; // Three.js„Çπ„Ç±„Éº„É´„Å´Â§âÊèõ
            const geometry = new THREE.SphereGeometry(size, 32, 32);
            const material = new THREE.MeshStandardMaterial({
                color: isTracking ? 0x00ffc2 : 0xff4655,
                emissive: isTracking ? 0x00aa88 : 0xaa2233,
                emissiveIntensity: 0.3,
                metalness: 0.3,
                roughness: 0.4
            });
            const sphere = new THREE.Mesh(geometry, material);
            
            // „Ç∞„É≠„ÉºÂäπÊûú
            const glowGeometry = new THREE.SphereGeometry(size * 1.2, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: isTracking ? 0x00ffc2 : 0xff4655,
                transparent: true,
                opacity: 0.15
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            sphere.add(glow);
            
            sphere.userData = { hit: false, isTracking };
            return sphere;
        }

        function spawnTarget() {
            if (!state.isPlaying) return;
            clearTargets3D();
            
            const target = createTarget3D(false);
            const pos = getRandomPosition3D();
            target.position.set(pos.x / 100, pos.y / 100, pos.z / 100);
            scene.add(target);
            targets3D.push(target);
            
            state.lastTargetTime = Date.now();
        }
        
        function clearTargets3D() {
            targets3D.forEach(t => scene.remove(t));
            targets3D.length = 0;
        }

        function startTracking() {
            trackingIndicator.classList.add('active');
            clearTargets3D();
            
            const target = createTarget3D(true);
            scene.add(target);
            targets3D.push(target);
            
            let x = 0, y = 0, z = -6;
            // „Éà„É©„ÉÉ„Ç≠„É≥„Ç∞ÈÄüÂ∫¶„ÇíÈÅ©Áî®
            const baseSpeedX = 0.06;
            const baseSpeedY = 0.04;
            const speedMultiplier = state.trackingSpeed;
            let vx = (Math.random() - 0.5) * baseSpeedX * speedMultiplier, 
                vy = (Math.random() - 0.5) * baseSpeedY * speedMultiplier;
            let trackingPoints = 0, totalFrames = 0;
            
            function move() {
                if (!state.isPlaying) return;
                if (Math.random() < 0.02) { 
                    vx += (Math.random() - 0.5) * 0.03 * speedMultiplier; 
                    vy += (Math.random() - 0.5) * 0.02 * speedMultiplier; 
                }
                const maxSpeedX = 0.05 * speedMultiplier;
                const maxSpeedY = 0.04 * speedMultiplier;
                vx = Math.max(-maxSpeedX, Math.min(maxSpeedX, vx)); 
                vy = Math.max(-maxSpeedY, Math.min(maxSpeedY, vy));
                x += vx; y += vy;
                if (Math.abs(x) > 4) vx *= -1;
                if (Math.abs(y) > 2) vy *= -1;
                x = Math.max(-4, Math.min(4, x));
                y = Math.max(-2, Math.min(2, y));
                target.position.set(x, y, z);
                
                // „É¨„Ç§„Ç≠„É£„Çπ„Éà„Åß„Éí„ÉÉ„ÉàÂà§ÂÆö
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
                const intersects = raycaster.intersectObject(target);
                
                totalFrames++;
                if (intersects.length > 0) {
                    trackingPoints++;
                    state.score = Math.floor(trackingPoints / 2);
                    scoreDisplay.textContent = state.score;
                }
                const acc = totalFrames > 0 ? (trackingPoints / totalFrames) * 100 : 0;
                trackingFill.style.width = acc + '%';
                accuracyDisplay.textContent = Math.round(acc) + '%';
                state.targetTimer = requestAnimationFrame(move);
            }
            move();
        }

        function scheduleReactionTarget() {
            if (!state.isPlaying) return;
            clearTargets3D();
            state.targetTimer = setTimeout(() => {
                if (!state.isPlaying) return;
                const target = createTarget3D(false);
                const pos = getRandomPosition3D();
                target.position.set(pos.x / 100, pos.y / 100, pos.z / 100);
                scene.add(target);
                targets3D.push(target);
                state.lastTargetTime = Date.now();
                setTimeout(() => {
                    if (targets3D.includes(target) && !target.userData.hit) {
                        scene.remove(target);
                        targets3D.splice(targets3D.indexOf(target), 1);
                        state.misses++; state.totalClicks++;
                        updateAccuracy();
                        scheduleReactionTarget();
                    }
                }, 1000);
            }, 500 + Math.random() * 1000);
        }

        function spawnGridTargets() {
            if (!state.isPlaying) return;
            clearTargets3D();
            
            // ÂÆåÂÖ®„Å´„É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„Å´5„Å§„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÈÖçÁΩÆÔºàÈùûÂ∏∏„Å´Â∫É„ÅÑÁØÑÂõ≤Ôºâ
            const numTargets = 5;
            // Ë¶ñÈáéËßí„ÇíËÄÉÊÖÆ„Åó„ÅüÂ∫É„ÅÑÁØÑÂõ≤
            const minX = -10, maxX = 10;
            const minY = -6, maxY = 6;
            const minZ = -12, maxZ = -2;
            
            for (let i = 0; i < numTargets; i++) {
                // ÂÆåÂÖ®„Å´„É©„É≥„ÉÄ„É†„Å™‰ΩçÁΩÆ„ÇíÁîüÊàê
                const x = minX + Math.random() * (maxX - minX);
                const y = minY + Math.random() * (maxY - minY);
                const z = minZ + Math.random() * (maxZ - minZ);
                
                const target = createTarget3D(false);
                target.position.set(x, y, z);
                scene.add(target);
                targets3D.push(target);
            }
            state.lastTargetTime = Date.now();
        }

        function hitTarget3D(target) {
            target.userData.hit = true;
            showHitMarker();
            playHitSound();
            state.hits++;
            state.score += 100;
            scoreDisplay.textContent = state.score;
            
            // „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
            const scale = { value: 1 };
            const animate = () => {
                scale.value += 0.1;
                target.scale.set(scale.value, scale.value, scale.value);
                target.material.opacity = Math.max(0, 1 - (scale.value - 1) / 0.5);
                target.material.transparent = true;
                if (scale.value < 1.5) {
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(target);
                    const idx = targets3D.indexOf(target);
                    if (idx > -1) targets3D.splice(idx, 1);
                }
            };
            animate();
        }

        function showHitMarker() {
            hitMarker.classList.remove('show');
            void hitMarker.offsetWidth;
            hitMarker.classList.add('show');
        }

        function updateAccuracy() {
            accuracyDisplay.textContent = state.totalClicks === 0 ? '100%' : 
                Math.round((state.hits / state.totalClicks) * 100) + '%';
        }

        function endGame() {
            state.isPlaying = false;
            clearInterval(state.gameTimer);
            clearTimeout(state.targetTimer);
            cancelAnimationFrame(state.targetTimer);
            if (document.exitPointerLock) document.exitPointerLock();
            clearTargets3D();
            trackingIndicator.classList.remove('active');
            
            const avgTime = state.reactionTimes.length > 0 ?
                Math.round(state.reactionTimes.reduce((a, b) => a + b, 0) / state.reactionTimes.length) : 0;
            const acc = state.currentMode === 'tracking' ? accuracyDisplay.textContent :
                (state.totalClicks > 0 ? Math.round((state.hits / state.totalClicks) * 100) + '%' : '100%');
            
            // ÂäπÁéáÂÄ§„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫
            const accNum = parseFloat(acc) / 100;
            const efficiency = Math.round(state.score * accNum);
            
            document.getElementById('finalScore').textContent = state.score;
            document.getElementById('finalAccuracy').textContent = acc;
            document.getElementById('finalAvgTime').textContent = efficiency + ' pts';
            
            // È†Ü‰Ωç„ÇíË®àÁÆó„Åó„Å¶Ë°®Á§∫ÔºàÂâçÂõû„ÅÆÂêçÂâç„Çí‰ΩøÁî®Ôºâ
            const savedName = localStorage.getItem('deadeyePlayerName') || 'Player';
            const rank = calculateRank(state.currentMode, efficiency, savedName);
            const rankValue = document.getElementById('rankValue');
            const resultRank = document.getElementById('resultRank');
            
            if (rank === -1) {
                rankValue.textContent = 'Êù°‰ª∂‰∏çÈÅ©Âêà';
                resultRank.classList.remove('new-record');
            } else if (rank <= 50) {
                rankValue.textContent = '#' + rank;
                resultRank.classList.toggle('new-record', rank === 1);
            } else {
                rankValue.textContent = 'ÂúèÂ§ñ';
                resultRank.classList.remove('new-record');
            }
            
            // ‰∏ÄÊôÇ‰øùÂ≠òÁî®„ÅÆ„Çπ„Ç≥„Ç¢„Éá„Éº„Çø„Çí‰øùÊåÅ
            state.pendingScore = {
                mode: state.currentMode,
                score: state.score,
                accuracy: acc
            };
            
            // ÂâçÂõû„ÅÆÂêçÂâç„ÇíÂæ©ÂÖÉ
            const playerNameInput = document.getElementById('playerNameInput');
            playerNameInput.value = savedName || '';
            
            // „Ç™„Éº„Éà„Çª„Éº„ÉñÔºö„Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„Å´Ëá™Âãï„Åß„Çπ„Ç≥„Ç¢„Çí‰øùÂ≠ò
            saveScore(state.currentMode, state.score, acc, savedName);
            
            // „Éó„É¨„Ç§„É§„ÉºÂêçÂ§âÊõ¥ÊôÇ„Å´ÂÜç‰øùÂ≠ò
            playerNameInput.addEventListener('input', () => {
                const newName = playerNameInput.value.trim() || savedName;
                if (newName !== savedName) {
                    saveScore(state.currentMode, state.score, acc, newName);
                }
            });
            
            // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Ë°®Á§∫
            const retryBtn = document.getElementById('retryBtn');
            const menuBtn = document.getElementById('menuBtn');
            const cooldownDiv = document.getElementById('resultCooldown');
            const cooldownTimer = document.getElementById('cooldownTimer');
            
            retryBtn.disabled = true;
            menuBtn.disabled = true;
            cooldownDiv.classList.remove('hidden');
            
            let countdown = 3;
            cooldownTimer.textContent = countdown;
            
            const cooldownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    cooldownTimer.textContent = countdown;
                } else {
                    clearInterval(cooldownInterval);
                    retryBtn.disabled = false;
                    menuBtn.disabled = false;
                    cooldownDiv.classList.add('hidden');
                }
            }, 1000);
            
            resultOverlay.classList.add('active');
        }

        function retryGame() {
            // „Éó„É¨„Ç§„É§„ÉºÂêç„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÂÜç‰øùÂ≠ò
            const playerNameInput = document.getElementById('playerNameInput');
            const currentName = playerNameInput.value.trim();
            const savedName = localStorage.getItem('deadeyePlayerName') || 'Player';
            
            if (currentName && currentName !== savedName && state.pendingScore) {
                saveScore(state.pendingScore.mode, state.pendingScore.score, state.pendingScore.accuracy, currentName);
            }
            
            state.pendingScore = null;
            resultOverlay.classList.remove('active');
            resetState();
            state.waitingForClick = true;
            clickToStart.classList.add('active');
        }

        function backToMenu() {
            // „Éó„É¨„Ç§„É§„ÉºÂêç„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÂÜç‰øùÂ≠ò
            const playerNameInput = document.getElementById('playerNameInput');
            const currentName = playerNameInput.value.trim();
            const savedName = localStorage.getItem('deadeyePlayerName') || 'Player';
            
            if (currentName && currentName !== savedName && state.pendingScore) {
                saveScore(state.pendingScore.mode, state.pendingScore.score, state.pendingScore.accuracy, currentName);
            }
            
            state.pendingScore = null;
            
            state.isPlaying = false;
            state.waitingForClick = false;
            clearInterval(state.gameTimer);
            clearTimeout(state.targetTimer);
            cancelAnimationFrame(state.targetTimer);
            if (document.exitPointerLock) document.exitPointerLock();
            
            hud.classList.remove('active');
            escHint.classList.remove('active');
            backBtn.classList.remove('active');
            instructions.classList.remove('active');
            crosshair.classList.remove('active');
            resultOverlay.classList.remove('active');
            trackingIndicator.classList.remove('active');
            clickToStart.classList.remove('active');
            countdown.classList.remove('active');
            menuScreen.classList.remove('hidden');
            
            clearTargets3D();
            state.pitch = 0; state.yaw = 0;
            updateWorld();
        }
    </script>
</body>
</html>
